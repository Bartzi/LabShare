{% extends "base.html" %}

{% load staticfiles %}
{% load icon %}
{% load bootstrap3 %}

{% block extra_css %}
    <!-- DataTables CSS -->
    <link href="{% static "node_modules/datatables.net-bs/css/dataTables.bootstrap.min.css" %}" rel="stylesheet">
{% endblock %}

{% block content %}
    <div class="col-lg-12" id="gpu-overview">
        <div class="panel panel-default">
            <div class="panel-body">
                <table class="table table-hover" id="overview-table">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>GPU</th>
                            <th>Memory Usage</th>
                            <th>Processes</th>
                            <th>Last Update</th>
                            <th>Current</th>
                            <th>Next</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody style="background-color: #fff;">
                        {% for device in devices %}
                            {% for gpu in device.gpus.all %}
                                <tr id="{{ gpu.uuid }}">
                                    <td>{{ device.name }}</td>
                                    <td>{{ gpu.model_name }}</td>
                                    <td class="gpu-memory">- MiB / - MiB</td>
                                    <td class="gpu-processes">
                                        <button class="gpu-process-show btn btn-xs btn-info" disabled data-device="{{ device.name }}" data-gpu-uuid="{{ gpu.uuid }}">0 Processes</button>
                                    </td>
                                    <td class="gpu-last-update">--</td>
                                    <td class="gpu-current-reservation"></td>
                                    <td class="gpu-next-reservation"></td>
                                    <td class="gpu-actions">
                                        <span class="gpu-done-button hidden">
                                            <button type="button" class="action-button btn btn-xs btn-success" data-action="{% url 'done_with_gpu' gpu.id %}">Done</button>
                                        </span>
                                        <span class="gpu-cancel-button hidden">
                                            <button type="button" class="action-button btn btn-xs btn-danger" data-action="{% url 'cancel_gpu' gpu.id %}">Cancel</button>
                                        </span>
                                        <span class="gpu-reserve-button">
                                            <button type="button" class="action-button btn btn-xs btn-warning"
                                                    data-gpu="{{ gpu.uuid }}" data-device="{{ device.name }}"
                                                    data-action="{% url 'reserve' %}">
                                                Reserve
                                            </button>
                                        </span>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- /.row -->

    <div id="templates" class="hidden">
        {% include "process_list_base.html" %}
        {% include "process_list_body.html" %}
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <!-- DataTables JavaScript -->
    <script src="{% static "node_modules/datatables.net/js/jquery.dataTables.min.js" %}"></script>
    <script src="{% static "node_modules/datatables.net-bs/js/dataTables.bootstrap.min.js" %}"></script>
    <script src="{% static "node_modules/reconnectingwebsocket/reconnecting-websocket.min.js" %}"></script>
    <script src="{% static "node_modules/pluralize/pluralize.js" %}"></script>

    <script type="module">
        const deviceNames = [{% for device in devices %}"{{ device.name }}"{% if not forloop.last %},{% endif %}{% endfor %}];
        const currentUser = "{{ user.username }}";

        import setUpWebsockets from '{% static "js/data_parser.js" %}';

        $(document).ready(function() {
            setUpWebsockets(deviceNames, currentUser);

            $('#overview-table').DataTable({
                responsive: true,
                paging: false,
                dom: 'ti',
                "columnDefs": [
                    {"orderable": false, "targets": [3, 7]}
                ]
            });
        });
    </script>
{% endblock %}
